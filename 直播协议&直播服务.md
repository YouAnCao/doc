# 直播协议 & 从零开始搭建直播环境

[TOC]

## 推拉流协议的介绍

### RTMP协议

> RTMP（Real Time Messaging Protocol） 是由 Adobe 公司基于 Flash Player 播放器对应的音视频 flv 封装格式提出的一种，基于TCP 的数据传输协议。本身具有稳定、兼容性强、高穿透的特点。常被应用于流媒体直播、点播等场景。常用于推推流方（主播）的稳定传输需求。

RTMP本质上是流协议，主要的优势是：  

> * 实时性高：RTMP的实时性在3秒之内，经过多层CDN节点分发后，实时性也在3秒左右。在一些实时性有要求的应用中以RTMP为主。

> * 支持加密：RTMPE和RTMPS为加密协议。虽然HLS也有加密，但在PC平台上flash对RTMPE/RTMPS支持应该比较不错。

> * 稳定性高：在PC平台上flash播放的最稳定方式是RTMP，如果做CDN或者大中型集群分发，选择稳定性高的协议一定是必要的。HTTP也很稳定，但HTTP是在协议上稳定；稳定性不只是服务端的事情，在集群分发，服务器管理，主备切换，客户端的支持上，RTMP在PC分发这种方式上还是很有优势。

> * 编码器接入：编码器输出到互联网（还可以输出为udp组播之类广电应用），主要是RTMP。譬如专业编码器，或者flash网页编码器，或者FMLE，或者ffmpeg，或者安防摄像头，都支持RTMP输出。若需要接入多种设备，譬如提供云服务；或者希望网页直接采集摄像头；或者能在不同编码器之间切换，那么RTMP作为服务器的输入协议会是最好的选择。

> * 系统容错：容错有很多种级别，RTMP的集群实现时可以指定N上层，在错误时切换不会影响到下层或者客户端，另外RTMP的流没有标识，切到其他的服务器的流也可以继续播放。HLS的流热备切换没有这么容易。若对于直播的容错要求高，譬如降低出问题的概率，选择RTMP会是很好的选择。

> * 可监控：在监控系统或者运维系统的角度看，流协议应该比较合适监控。HTTP的流监控感觉没有那么完善。这个不算绝对优势，但比较有利。

### HLS协议

> * 是苹果公司实现的基于 HTTP 的流媒体传输协议，全称 HTTP Live Streaming，可支持流媒体的直播和点播;

> * HLS 的基本原理就是当采集推流端将视频流推送到流媒体服务器时，服务器将收到的流信息每缓存一段时间就封包成一个新的 ts 文件，同时服务器会建立一个 m3u8 的索引文件来维护最新几个 ts 片段的索引。当播放端获取直播时，它是从 m3u8 索引文件获取最新的 ts 视频文件片段来播放，从而保证用户在任何时候连接进来时都会看到较新的内容，实现近似直播的体验。相对于常见的流媒体直播协议，例如 RTMP 协议、RTSP 协议等，HLS 最大的不同在于直播客户端获取到的并不是一个完整的数据流，而是连续的、短时长的媒体文件，客户端不断的下载并播放这些小文件。

> * 通常 HLS 直播延时会达到 20-30s，而高延时对于需要实时互动体验的直播来说是不可接受的。

> * HLS 基于短连接 HTTP，HTTP 是基于 TCP 的，这就意味着 HLS 需要不断地与服务器建立连接，TCP 每次建立连接时的三次握手、慢启动过程、断开连接时的四次挥手都会产生消耗。

## 直播相关组件与工具介绍

### nginx-rtmp-module 推流服务器

* nginx-rtmp-module 是一个开源的支持rtmp协议的nginx模块，用于处理直播推流服务，具有上手难度较低，易于拓展等特点；
* github [nginx-rtmp-module](https://github.com/arut/nginx-rtmp-module)

### OBS & VLC 推拉流客户端

* OBS  [OBS官网](https://obsproject.com/zh-tw)
> OBS是一个用于录制和进行网络直播的自由开源软件包。OBS使用C和C++语言编写，提供实时源和设备捕获、场景组成、编码、录制和广播。数据传输主要通过实时消息协议（RTMP）完成，可以发送到任何支持RTMP的软件，包括YouTube、Twitch.tv、Instagram和Facebook等流媒体网站;

* VLC  [VLC官网](https://www.videolan.org/)
> VLC多媒体播放器（VLC media player），最初名为VideoLAN Client，是VideoLAN计划的开放源代码多媒体播放器。支持众多音频与视频解码器及文件格式，并支持DVD影音光盘、VCD影音光盘及各类流协议。它也能作为单播或多播的流服务器在IPv4或IPv6的高速网络连线下使用;

## 一个简单的直播服务架构

![image.png](https://i.loli.net/2021/07/07/gAevpiWNJDtUbFB.png)


## 搭建直播环境  
### 1. 环境准备  

* CentOS 6.5 2c8g
* nginx [1.20.1](https://nginx.org/en/download.html)
  > Nginx是异步框架的网页服务器，也可以用作反向代理、负载平衡器和HTTP缓存。
* rtmp_nginx_module [v1.2.2](https://github.com/arut/nginx-rtmp-module)
* pcre [8.45](https://ftp.pcre.org/pub/pcre/)
  > PCRE(Perl Compatible Regular Expressions)是一个Perl库，包括 perl 兼容的正则表达式库。
* zlib [1.2.11](https://zlib.net/)
  > zlib是提供数据压缩用的函式库，由Jean-loup Gailly与Mark Adler所开发。
* openssl [1.1.1k](https://www.openssl.org/source/)
  > OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通信，避免窃听，同时确认另一端连线者的身份。这个包广泛被应用在互联网的网页服务器上。 其主要库是以C语言所写成，实现了基本的加密功能，实现了SSL与TLS协议。

### 2. 安装nginx并支持rtmp协议解析与转发  
* 手动编译nginx & nginx-rtmp-module 
```shell

```
### 3. 添加rtmp流媒体监控  
### 4. 使用工具推流并直播  

## ffmpeg
### 基础知识

[分辨率、帧速率、比特率、视频格式的关系](https://zhuanlan.zhihu.com/p/60868555)

### ffmpeg 介绍

### ffmpeg 基本使用
#### ffmpeg 推流
#### ffplay 拉流
#### ffmpeg 加水印
#### ffmpeg 转推流
